<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="author" content="HilandoPixel">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <meta content="carrera, fotos, running, tusresulta2, rutamiel" name="keywords">
    <meta content="BÃºsqueda de fotos y resultados de la Ruta de la miel 2025" name="description">
    <meta property="og:image" content="https://hilandopixel.github.io/tusresulta2/rutadelamiel2025/preview.png">
    <meta property="og:title" content="Ruta Miel 2025 Infantil - TusResulta2 - BÃºsqueda de fotos" />
    <meta property="og:description" content="BÃºsqueda de fotos y resultados de la Ruta de la miel 2025" />
    <title>Ruta Miel 2025 Infantil - TusResulta2 - BÃºsqueda de fotos</title>

    <link rel="icon" href="/assets/favicon.ico">
    <link rel="stylesheet" href="/assets/style.css">
</head>
<body>
    <h1 class="custom-text text-center">Ruta de la Miel 2025 - TusResulta2</h1>
    <h2 class="custom-text-pink text-center">Infantil</h2>

    <div class="">
        <img class="width-full" src="../preview.png" />
        <div class="card custom-pink">
            <div class="filter">

                <div class="filter-group">
                    <p>Â¿QuÃ© tiempo has hecho en formato hh:mm:ss?</p>
                    <p>Buscamos fotos con un margen de Â± 30s:</p>
                    <input type="text" id="timeInput" placeholder="Por ejemplo: 01:15:30" />
                    <button class="custom-lightblue" onclick="filterByTime()">Buscar</button>
                    <button class="custom-lightblue" onclick="resetFilter('time')">Limpiar</button>
                </div>

            </div>
        </div>
    </div>

    <div id="progress" class="progress custom-text-pink text-center">Cargando...</div>


    <div id="gallery" class="gallery">


    </div>

    <script>
        const dateOffset = 30000; // 30 seconds in milliseconds
        const timeOffset = 30;    // 30 seconds
        const filename = './fotos.json';
        const batchSize = 10;

        let allImages = [];
        let filteredImages = [];
        let currentIndex = 0;
        let loading = false;

        // ðŸ†• NEW Helper Function: Converts "HH:mm:ss" string to seconds from midnight
        function timeToSeconds(timeStr) {
            const parts = timeStr.split(':').map(Number);
            if (parts.length === 3) {
                return parts[0] * 3600 + parts[1] * 60 + parts[2];
            }
            return NaN;
        }

        async function loadImages() {
            const res = await fetch(filename);
            const data = await res.json();
            let arrayData = Array.isArray(data) ? data : (data.photos || data.items || []);
            allImages = arrayData.sort((a, b) => a.date - b.date);
            filteredImages = allImages;
            currentIndex = 0;
            document.getElementById('gallery').innerHTML = '';
            updateProgress();
            loadNextBatch();
            window.addEventListener('scroll', handleScroll);
        }

        function createCard(item) {
            const card = document.createElement('div');
            card.className = 'card custom-pink';

            const img = document.createElement('img');
            img.loading = 'lazy'; // native lazy loading
            img.dataset.src = item.imageurl;
            img.alt = 'Foto';
            observer.observe(img);

            const dateDiv = document.createElement('div');
            dateDiv.className = 'date';
            dateDiv.textContent = 'Tiempo: ' + item.resulttime;

            const link = document.createElement('a');
            link.className = 'custom-lightblue'
            link.href = item.href; // Maps to the JSON 'href' property
            link.target = '_blank'; // Opens in a new tab
            link.textContent = 'Ver Foto TamaÃ±o Completo';
            link.style.display = 'block'; // Make it take up its own line
            link.style.padding = '0 10px 10px'; // Add padding below the date
            link.style.fontSize = '12px';
            link.style.color = '#0066cc'; // Simple link color
            link.style.textDecoration = 'none'; // Remove underline
            link.onmouseover = () => link.style.textDecoration = 'underline';
            link.onmouseout = () => link.style.textDecoration = 'none';

            card.appendChild(img);
            card.appendChild(dateDiv);
            card.appendChild(link); // Append the new link below the date

            return card;
        }

        function loadNextBatch() {
            if (loading) return;
            loading = true;

            const gallery = document.getElementById('gallery');
            const nextItems = filteredImages.slice(currentIndex, currentIndex + batchSize);

            nextItems.forEach(item => {
                const card = createCard(item);
                gallery.appendChild(card);
            });

            currentIndex += nextItems.length;
            updateProgress();
            loading = false;
        }

        function handleScroll() {
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 200) {
                if (currentIndex < filteredImages.length) {
                    loadNextBatch();
                }
            }
        }

        // IntersectionObserver for real lazy loading
        const observer = new IntersectionObserver((entries, obs) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.src = img.dataset.src;
                    obs.unobserve(img);
                }
            });
        }, {
            rootMargin: '200px'
        });

        // ðŸ†• NEW Filter Function: Filters by resulttime (HH:mm:ss) +/- 30 seconds
        function filterByTime() {
            const input = document.getElementById('timeInput').value.trim();
            const inputSeconds = timeToSeconds(input);

            if (isNaN(inputSeconds) || !/^\d{1,2}:\d{2}:\d{2}$/.test(input)) {
                loadImages();
                return;
            }

            const lower = inputSeconds - timeOffset;
            const upper = inputSeconds + timeOffset;

            // Apply the filter on allImages
            filteredImages = allImages.filter(img => {
                const itemSeconds = timeToSeconds(img.resulttime);
                return itemSeconds >= lower && itemSeconds <= upper;
            });


            currentIndex = 0;
            document.getElementById('gallery').innerHTML = '';
            updateProgress();
            loadNextBatch();
        }

        function resetFilter(type) {
            if (type === 'time') {
                document.getElementById('timeInput').value = '';
            }
            resetAllFilters();
        }

        function resetAllFilters() {
            document.getElementById('timeInput').value = '';
            filteredImages = allImages;
            currentIndex = 0;
            document.getElementById('gallery').innerHTML = '';
            updateProgress();
            loadNextBatch();
        }

        function updateProgress() {
            const progress = document.getElementById('progress');
            const total = filteredImages.length;
            const shown = Math.min(currentIndex, total);
            if (total === 0) {
                progress.textContent = 'No hay imÃ¡genes para mostrar.';
            } else {
                progress.textContent = `Mostrando ${shown} / ${total} fotos`;
            }
        }

        loadImages();
    </script>
</body>
</html>