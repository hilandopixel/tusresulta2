<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="author" content="HilandoPixel">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <meta content="carrera, fotos, running, tusresulta2, hilandopixel, rutamiel" name="keywords">
    <meta content="Búsqueda de fotos y resultados de la Ruta de la miel 2025" name="description">
    <meta property="og:image" content="https://hilandopixel.com/rutadelamiel2025/previewWeb.png">
    <meta property="og:title" content="Ruta Miel 2025 Alevin - TusResulta2 - Búsqueda de fotos" />
    <meta property="og:description" content="Búsqueda de fotos y resultados de la Ruta de la miel 2025" />
    <title>Ruta Miel 2025 Alevin - TusResulta2 - Búsqueda de fotos</title>

    <link rel="icon" href="/assets/favicon.ico">
    <link rel="stylesheet" href="/assets/style.css">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

</head>
<body>
    <h1 class="custom-text text-center">Ruta de la Miel 2025 - TusResulta2</h1>
    <h2 class="custom-text-pink text-center">Alevin</h2>

    <div class="">
        <img class="width-full" src="../preview.png" />
        <div class="card custom-pink">
            <div class="filter">
                <div class="filter-group">
                    <p>Busca por tiempo (hh:mm:ss) o por dorsal:</p>
                    <input type="text" id="timeInput" placeholder="Ejemplo: 01:15:30 o 227" />
                    <button class="btn btn-primary custom-lightblue " onclick="filterByTime()">Buscar</button>
                    <button class="btn btn-primary custom-lightblue " onclick="resetFilter('time')">Limpiar</button>

                    <button class="btn btn-primary custom-lightblue "
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#resultsCollapse"
                            aria-expanded="false"
                            aria-controls="resultsCollapse"
                            onclick="renderResultsTable()">
                        Ver resultados
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid mb-4">
        <div class="collapse" id="resultsCollapse">
            <h3 class="custom-text-pink text-center mt-4">Resultados de la Carrera</h3>
            <div id="resultsTableContainer" class="result-card-container">
            </div>
        </div>
    </div>
    <div id="progress" class="progress custom-text-pink text-center">Cargando...</div>

    <div id="gallery" class="gallery">
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script>
        // Global variable to hold the results data
        window.resultsData = null;

        const timeOffset = 30;    // 30 seconds
        const photosFilename = './fotos.json';
        const resultsFilename = './resultados.json'; // Results data path
        const batchSize = 10;

        let allImages = [];
        let filteredImages = [];
        let currentIndex = 0;
        let loading = false;

        // --- Core Data Loading Functions ---

        /**
         * Fetches and stores the results data from the JSON file.
         */
        async function loadResultsData() {
            if (window.resultsData) return;

            try {
                const res = await fetch(resultsFilename);
                const data = await res.json();
                // Assumes the data array is under the key 'data'
                window.resultsData = Array.isArray(data.data) ? data.data : [];
                console.log('Results data loaded successfully.');
            } catch (error) {
                console.error('Error loading results data:', error);
                alert('Error al cargar los datos de resultados. La búsqueda por dorsal y el listado de resultados no funcionarán.');
            }
        }

        /**
         * Fetches the photo gallery data and initiates results data loading.
         */
        async function loadImages() {
            // Load results data in the background
            await loadResultsData();

            try {
                const res = await fetch(photosFilename);
                const data = await res.json();
                let arrayData = Array.isArray(data) ? data : (data.photos || data.items || []);
                allImages = arrayData.sort((a, b) => a.date - b.date);
                filteredImages = allImages;
                currentIndex = 0;
                document.getElementById('gallery').innerHTML = '';
                updateProgress();
                loadNextBatch();
                window.addEventListener('scroll', handleScroll);
            } catch (error) {
                console.error('Error loading photo data:', error);
            }
        }

        // --- UPDATED: Results Table Rendering Function ---

        /**
         * Renders the results data into a card-view HTML structure, filtered by the input field.
         */
        function renderResultsTable() {
            const container = document.getElementById('resultsTableContainer');
            const input = document.getElementById('timeInput').value.trim();
            // Regex for time format (e.g., 01:15:30)
            const timeFormatRegex = /^\d{1,2}:\d{2}:\d{2}$/;

            if (!window.resultsData) {
                container.innerHTML = '<p class="text-center text-secondary">Cargando resultados...</p>';
                loadResultsData().then(() => renderResultsTable()); // Try again once loaded
                return;
            }

            let dataToRender = window.resultsData;

            if (input) {
                // If input looks like HH:mm:ss, filter by tiempo
                if (timeFormatRegex.test(input)) {
                    // Filter by TIEMPO (simple containment for partial match, but exact match is recommended for time)
                    dataToRender = window.resultsData.filter(item =>
                        String(item.tiempo).includes(input)
                    );
                } else {
                    // Otherwise, filter by DORSAL (simple containment)
                    dataToRender = window.resultsData.filter(item =>
                        String(item.dorsal).includes(input)
                    );
                }
            }

            if (dataToRender.length === 0) {
                container.innerHTML = '<p class="text-center text-danger">No se encontraron resultados para el filtro aplicado.</p>';
                return;
            }

            let htmlContent = '';

            dataToRender.forEach(item => {
                // Logic to separate nombre and apellidos (Assumes first word is name, rest are surnames)
                const nameParts = item.nombre.split(' ');
                let firstName = nameParts.length > 0 ? nameParts[0] : '';
                let lastName = nameParts.length > 1 ? nameParts.slice(1).join(' ') : '';

                htmlContent += `
                            <div class="result-item-card custom-pink">
                                <span class="posicion">${item.posicion}º</span>
                                <strong class="custom-pink">${firstName} ${lastName}</strong>
                                <span  class="custom-pink">Dorsal: ${item.dorsal}</span>
                                <span  class="custom-pink">Tiempo: ${item.tiempo}</span>
                            </div>
                        `;
            });

            container.innerHTML = htmlContent;
        }


        // --- Utility and Existing Functions (Minor Updates) ---

        function timeToSeconds(timeStr) {
            const parts = timeStr.split(':').map(Number);
            if (parts.length === 3 && parts.every(p => !isNaN(p))) {
                return parts[0] * 3600 + parts[1] * 60 + parts[2];
            }
            return NaN;
        }

        function createCard(item) {
            const card = document.createElement('div');
            card.className = 'card custom-pink';

            const img = document.createElement('img');
            img.loading = 'lazy';
            img.dataset.src = item.imageurl;
            img.alt = 'Foto';
            observer.observe(img);

            const dateDiv = document.createElement('div');
            dateDiv.className = 'date';
            dateDiv.textContent = 'Tiempo: ' + item.resulttime;

            const link = document.createElement('a');
            link.className = 'custom-lightblue'
            link.href = item.imageurl;
            link.target = '_blank';
            link.textContent = 'Ver Foto Tamaño Completo';
            link.style.display = 'block';
            link.style.padding = '0 10px 10px';
            link.style.fontSize = '12px';
            link.style.color = '#0066cc';
            link.style.textDecoration = 'none';
            link.onmouseover = () => link.style.textDecoration = 'underline';
            link.onmouseout = () => link.style.textDecoration = 'none';
            link.download = 'foto.jpg'
            card.appendChild(img);
            card.appendChild(dateDiv);
            card.appendChild(link);
            return card;
        }

        function loadNextBatch() {
            if (loading) return;
            loading = true;

            const gallery = document.getElementById('gallery');
            const nextItems = filteredImages.slice(currentIndex, currentIndex + batchSize);

            nextItems.forEach(item => {
                const card = createCard(item);
                gallery.appendChild(card);
            });

            currentIndex += nextItems.length;
            updateProgress();
            loading = false;
        }

        function handleScroll() {
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 200) {
                if (currentIndex < filteredImages.length) {
                    loadNextBatch();
                }
            }
        }

        const observer = new IntersectionObserver((entries, obs) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const img = entry.target;
                    img.src = img.dataset.src;
                    obs.unobserve(img);
                }
            });
        }, {
            rootMargin: '200px'
        });

        function filterByTime() {
            const input = document.getElementById('timeInput').value.trim();
            const timeFormatRegex = /^\d{1,2}:\d{2}:\d{2}$/;
            let timeToFilter = null;

            if (!input) {
                resetAllFilters();
                return;
            }

            if (timeFormatRegex.test(input)) {
                timeToFilter = input;

            } else {
                if (!window.resultsData || !Array.isArray(window.resultsData)) {
                    alert('Error: Datos de resultados no cargados. Intente recargar la página.');
                    return;
                }

                const runner = window.resultsData.find(item => String(item.dorsal).trim() === input);

                if (runner && runner.tiempo) {
                    timeToFilter = runner.tiempo;
                    document.getElementById('timeInput').value = timeToFilter;
                } else {
                    alert('Dorsal no encontrado o no tiene un tiempo válido asociado.');
                    resetAllFilters();
                    return;
                }
            }

            const inputSeconds = timeToSeconds(timeToFilter);

            if (isNaN(inputSeconds)) {
                alert('El tiempo asociado (' + timeToFilter + ') no es válido para filtrar.');
                resetAllFilters();
                return;
            }

            const lower = inputSeconds - timeOffset;
            const upper = inputSeconds + timeOffset;

            filteredImages = allImages.filter(img => {
                const itemSeconds = timeToSeconds(img.resulttime);
                return itemSeconds >= lower && itemSeconds <= upper;
            });


            currentIndex = 0;
            document.getElementById('gallery').innerHTML = '';
            updateProgress();
            loadNextBatch();
            document.getElementById('gallery').scrollIntoView({ behavior: 'smooth' });

            // OPTIONAL: Update results display immediately if it's open
            if (document.getElementById('resultsCollapse').classList.contains('show')) {
                renderResultsTable();
            }
        }

        function resetFilter(type) {
            if (type === 'time') {
                document.getElementById('timeInput').value = '';
            }
            resetAllFilters();
        }

        function resetAllFilters() {
            document.getElementById('timeInput').value = '';
            filteredImages = allImages;
            currentIndex = 0;
            document.getElementById('gallery').innerHTML = '';
            updateProgress();
            loadNextBatch();

            // NEW: Clear the results container when the filter is reset
            document.getElementById('resultsTableContainer').innerHTML = '';
        }

        function updateProgress() {
            const progress = document.getElementById('progress');
            const total = filteredImages.length;
            const shown = Math.min(currentIndex, total);
            if (total === 0) {
                progress.textContent = 'No hay imágenes para mostrar.';
            } else {
                progress.textContent = `Mostrando ${shown} / ${total} fotos`;
            }
        }

        // Start the process
        loadImages();
    </script>
</body>
</html>